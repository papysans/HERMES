# 使用手册：Hermes 命令与模式速查（2026-02-14）

## 1. 适用范围

本手册基于当前运行实现：

1. `plugins/lib/permission-listener.js`
2. `plugins/lib/control-state.js`
3. `workspace-hermes/SOUL.md`

## 2. 消息路由规则（先看这个）

1. **带括号**（`（...）` 或 `(...)`）是控制指令，优先由 Hermes 本地处理，不转发给 OpenCode。
2. **不带括号**是任务消息，会转发到 OpenCode。
3. 群组若开启 `requireMention=true`，则消息需要 `@Napsta6100ks_bot` 才会触发。
4. `继续执行` 这类推进消息应发为普通消息，**不要写成括号命令**。

## 3. 控制命令速查

### 3.1 模式与接管

1. `（模式:转发）` / `（mode:forward）`
2. `（模式:协同）` / `（mode:copilot）`
3. `（模式:代决策）` / `（mode:delegate）`
4. `（接管: <目标>）` / `（takeover: <goal>）`
5. `（停止接管）` / `（stop takeover）`

### 3.2 Agent 与 Skill

1. `（选择Agent）` / `（select agent）`：弹按钮菜单。
2. `（切换Agent: hephaestus）`
3. `（set agent: hephaestus）`
4. `（agent: hephaestus）`
5. `（skill:plan）` / `（skill:execute）` / `（skill:debug）` / `（skill:review）`

## 4. 三种模式说明

1. `forward`（转发）
   1. 只做桥接转发，不做任务编排。
2. `copilot`（协同）
   1. 使用任务信封编排（目标、约束、验收、skill）。
   2. 权限请求默认仍需人工按钮确认。
3. `delegate`（代决策）
   1. 同样做任务编排。
   2. 当前实现支持“低风险权限自动 `RUN(once)`”。
   3. 中/高风险权限仍保留人工按钮确认。

## 5. Skill Profile 映射

1. `plan -> superpowers/writing-plans`
2. `execute -> superpowers/executing-plans`
3. `debug -> superpowers/systematic-debugging`
4. `review -> superpowers/requesting-code-review`

## 6. 权限与 Question Tool 规则

1. 权限由 Permission Bot 下发按钮：`RUN / ALWAYS / REJECT`。
2. 文字回复中，只有**精确命中** `RUN`/`ALWAYS`/`REJECT` 才会走权限提示分支。
3. 其他句子（如“继续执行，不用再确认”）应按普通任务消息路由。
4. Question Tool 自定义回答必须“回复 Permission Bot 发出的输入提示消息”，不要转发给 Napsta bot。

## 7. 常用状态与排查命令

### 7.1 控制状态

```bash
cat /tmp/hermes-control-state.json
```

### 7.2 Pending 状态（权限/问题）

```bash
cat /tmp/hermes-pending.json
```

### 7.3 查看当前 activeSessionId 消息类型

```bash
sid=$(jq -r '.activeSessionId' /tmp/hermes-control-state.json)
echo "$sid"
curl -sS "http://127.0.0.1:4096/session/$sid/message" | jq -r 'type'
```

### 7.4 查看会话最近消息摘要

```bash
curl -sS "http://127.0.0.1:4096/session/$sid/message" \
| jq -r '(if type=="array" then . else (.items // .messages // []) end)
  | .[]
  | [.info.role, (.info.agent // ""), ((.parts // []) | map(select(.type=="text") | .text) | join(" "))]
  | @tsv' \
| tail -n 20
```

## 8. 当前已知行为与注意事项

1. `（接管: ...）` 只表示“接管编排已开始并派发”，不等于任务已完成。
2. `PHASE_COMPLETE` 是阶段回执，不是自动继续执行；如需继续，请再发普通任务消息。
3. `/new` 后建议检查 `takeoverActive` 状态；必要时手动 `（停止接管）` 再重新 `（接管: ...）`。
4. 低风险自动批准逻辑变更后，需要重启 `permission-listener` 才会生效。

## 9. 推荐最小流程（稳定版）

1. `@Napsta6100ks_bot （模式:代决策）`
2. `@Napsta6100ks_bot （切换Agent: hephaestus）`
3. `@Napsta6100ks_bot （skill:execute）`
4. `@Napsta6100ks_bot （接管: <你的目标>）`
5. 收到 `PHASE_COMPLETE` 后，用普通消息推进：
   1. `@Napsta6100ks_bot 继续执行，完成后给我结果和验证输出。`
