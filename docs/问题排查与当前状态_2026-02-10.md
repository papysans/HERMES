# Hermes é—®é¢˜æ’æŸ¥ä¸å½“å‰çŠ¶æ€

> ğŸ“… åˆ›å»ºæ—¥æœŸ: 2026-02-10
> ğŸ“Œ ç‰ˆæœ¬: V1.0
> ğŸ¯ ç›®æ ‡: è®°å½•æ‰€æœ‰å·²å‘ç°çš„é—®é¢˜ã€æ ¹å› åˆ†æå’Œä¿®å¤çŠ¶æ€

---

## å·²è§£å†³çš„é—®é¢˜

### P1: HERMES_HOOK_TOKEN æœªè®¾ç½®

**æ ¹å› **: ç¯å¢ƒå˜é‡æœªåœ¨ `.zshrc` ä¸­æŒä¹…åŒ–ï¼Œæˆ– OpenCode å¯åŠ¨æ—¶æœª `source ~/.zshrc`ã€‚
**ä¿®å¤**: å·²æ·»åŠ åˆ° `~/.zshrc`ã€‚å¯åŠ¨ OpenCode å‰å¿…é¡» `source ~/.zshrc`ã€‚
**çŠ¶æ€**: âœ… å·²è§£å†³

### P2: åŒæ­¥ API é˜»å¡

**æ ¹å› **: OpenClaw agent ä½¿ç”¨ `POST /session/{id}/message`ï¼ˆåŒæ­¥ï¼‰ï¼Œè§¦å‘ permission æ—¶æ°¸è¿œæŒ‚èµ·ã€‚
**ä¿®å¤**: SOUL.md å’Œ TOOLS.md æ”¹ç”¨ `prompt_async`ã€‚
**çŠ¶æ€**: âœ… å·²è§£å†³

### P3: deliver æ¨¡å¼ä¸å·¥ä½œ

**æ ¹å› **: `deliver: true` éœ€è¦ prior delivery routeï¼Œæ²¡æœ‰æ—¶é™é»˜å¤±è´¥ã€‚
**ä¿®å¤**: ç»Ÿä¸€ä½¿ç”¨ `wakeMode: "now"` + `channel` + `to`ã€‚
**çŠ¶æ€**: âœ… å·²è§£å†³

### P4: æ¶ˆæ¯è·¯ç”±åˆ°ä¸» BOT DM

**æ ¹å› **: ä¸æŒ‡å®š `channel`/`to` æ—¶èµ°é»˜è®¤ delivery routeï¼ˆDMï¼‰ã€‚
**ä¿®å¤**: `sendToOpenClaw()` ç»Ÿä¸€å¸¦ `channel: "telegram"` + `to: "-5088310983"`ã€‚
**çŠ¶æ€**: âœ… å·²è§£å†³

---

## å½“å‰é˜»å¡é—®é¢˜

### P5: Webhook æ¶ˆæ¯è·¯ç”±åˆ°é”™è¯¯çš„ Agent âš ï¸ å…³é”®

**ç°è±¡**:
- hermes-hook.js å‘é€ webhook åˆ° `/hooks/agent`
- æ¶ˆæ¯è¢«è·¯ç”±åˆ° `coder` agent è€Œä¸æ˜¯ `kiro` agent
- è¯æ®: gateway.err.log ä¸­ `lane=session:agent:coder:hermes-notifications`
- ç»“æœ: æƒé™ç¡®è®¤æ¶ˆæ¯å‘åˆ°äº† coder agent çš„é€šé“ï¼ˆå¯èƒ½æ˜¯ DM æˆ– coder ç¾¤ç»„ `-5245978672`ï¼‰ï¼Œä¸åœ¨ kiro ç¾¤ç»„ `-5088310983` ä¸­å¯è§

**æ ¹å› åˆ†æ**:
- OpenClaw çš„ `/hooks/agent` ç«¯ç‚¹æ¥æ”¶ webhook åï¼Œéœ€è¦å†³å®šè·¯ç”±åˆ°å“ªä¸ª agent
- payload ä¸­æœ‰ `name: "Hermes"` å’Œ `sessionKey: "hermes-notifications"`
- OpenClaw å¯èƒ½æ ¹æ® `name` åŒ¹é… agentï¼Œ"Hermes" ä¸åŒ¹é…ä»»ä½• agent ID
- é»˜è®¤å¯èƒ½ fallback åˆ° `coder` agentï¼ˆç¬¬ä¸€ä¸ªé defaults çš„ agentï¼Ÿï¼‰
- è™½ç„¶ payload æœ‰ `channel: "telegram"` + `to: "-5088310983"`ï¼Œä½†è¿™åªå½±å“ deliveryï¼Œä¸å½±å“ agent è·¯ç”±

**å°è¯•çš„ä¿®å¤**:
- åœ¨ payload ä¸­æ·»åŠ  `agentId: "kiro"` â€” å·²ä¿®æ”¹ä»£ç ï¼Œå¾…éªŒè¯
- ä¸ç¡®å®š OpenClaw `/hooks/agent` æ˜¯å¦æ”¯æŒ `agentId` å‚æ•°

**å¾…éªŒè¯æ–¹æ¡ˆ**:
1. `agentId: "kiro"` æ˜¯å¦è¢« OpenClaw è¯†åˆ«
2. å¦‚æœä¸è¯†åˆ«ï¼Œå°è¯• `name: "kiro"` ä»£æ›¿ `name: "Hermes"`
3. å¦‚æœéƒ½ä¸è¡Œï¼Œå°è¯• `sessionKey` åŒ…å« agent IDï¼ˆå¦‚ `kiro:hermes-notifications`ï¼‰
4. æœ€ç»ˆæ–¹æ¡ˆï¼šæŸ¥çœ‹ OpenClaw æºç ç¡®è®¤è·¯ç”±é€»è¾‘

**ç›¸å…³æ—¥å¿—**:
```
# gateway.err.log
2026-02-10T13:28:25.348Z [diagnostic] lane wait exceeded: lane=session:agent:coder:hermes-notifications waitedMs=11883 queueAhead=1
2026-02-10T13:28:33.904Z [diagnostic] lane wait exceeded: lane=session:agent:coder:hermes-notifications waitedMs=15416 queueAhead=1
2026-02-10T13:28:40.091Z [diagnostic] lane wait exceeded: lane=session:agent:coder:hermes-notifications waitedMs=14740 queueAhead=0
```

### P6: ç”¨æˆ·å›å¤ RUN åæ— æ³•æ­£ç¡®è½¬å‘

**ç°è±¡**:
- ç”¨æˆ·åœ¨ TG ç¾¤ç»„å›å¤ "RUN"
- OpenClaw kiro agent çœ‹ä¸åˆ°ä¹‹å‰çš„ ğŸ”´ æ¶ˆæ¯ï¼ˆå› ä¸º P5ï¼Œæ¶ˆæ¯åœ¨ coder agent çš„ session é‡Œï¼‰
- agent æ— æ³•æå– sid/pidï¼Œæ— æ³•æ‰§è¡Œ curl å›ä¼  OpenCode
- èŠå¤©è®°å½•ä¸­æ˜¾ç¤º agent å°è¯•ç”¨ `POST /session/{sid}/permissions` ä½†è¿”å› HTML é¡µé¢ï¼ˆå¯èƒ½æ˜¯é”™è¯¯çš„ URL æˆ– session å·²è¿‡æœŸï¼‰

**æ ¹å› **: è¿™æ˜¯ P5 çš„ä¸‹æ¸¸é—®é¢˜ã€‚ä¿®å¤ P5 åï¼ŒğŸ”´ æ¶ˆæ¯ä¼šå‡ºç°åœ¨ kiro agent çš„ session ä¸­ï¼Œç”¨æˆ·å›å¤ RUN æ—¶ agent å°±èƒ½ä»ä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ° sid/pidã€‚

**ä¾èµ–**: P5 ä¿®å¤åè‡ªåŠ¨è§£å†³

### P7: Agent è‡ªä½œä¸»å¼ é£é™©

**ç°è±¡**: OpenClaw agent æ”¶åˆ° ğŸ”´ æ¶ˆæ¯åå¯èƒ½è‡ªè¡Œé€‰æ‹© RUN è€Œéç­‰å¾…ç”¨æˆ·ã€‚
**ç¼“è§£**: SOUL.md ä¸­æœ‰ HERMES_WEBHOOK é“å¾‹ï¼Œæ¶ˆæ¯å‰ç¼€ `[HERMES_WEBHOOK â€” è½¬å‘ç»™ç”¨æˆ·ï¼Œä¸è¦è‡ªå·±å¤„ç†]`ã€‚
**çŠ¶æ€**: âš ï¸ éœ€è¦åœ¨ P5 ä¿®å¤åéªŒè¯

---

## æ¶ˆæ¯æµå®Œæ•´é“¾è·¯

```
OpenCode æ‰§è¡Œå‘½ä»¤
    â†“ è§¦å‘ permission.asked äº‹ä»¶
hermes-hook.js æ•è·äº‹ä»¶
    â†“ æå– sid, pid, command, risk
    â†“ POST /hooks/agent (OpenClaw Gateway :18789)
OpenClaw Gateway æ¥æ”¶ webhook
    â†“ è·¯ç”±åˆ° agent (å½“å‰é—®é¢˜: è·¯ç”±åˆ° coder è€Œé kiro)
Agent å¤„ç†æ¶ˆæ¯
    â†“ åº”è¯¥: åŸæ ·è½¬å‘åˆ° TG ç¾¤ç»„ -5088310983
    â†“ å®é™…: å‘åˆ°äº†é”™è¯¯çš„åœ°æ–¹
ç”¨æˆ·åœ¨ TG ç¾¤ç»„çœ‹åˆ° ğŸ”´ æ¶ˆæ¯
    â†“ å›å¤ RUN
OpenClaw kiro agent æ”¶åˆ°ç”¨æˆ·å›å¤
    â†“ ä»ä¸Šä¸‹æ–‡æ‰¾åˆ° sid/pid
    â†“ exec: curl POST /session/{sid}/permissions/{pid} (OpenCode :4096)
OpenCode æ”¶åˆ°å®¡æ‰¹
    â†“ ç»§ç»­æ‰§è¡Œ
```

---

## Permission Event æ•°æ®ç»“æ„

æ¥è‡ª `/tmp/hermes-perm-*.json`ï¼š

```json
{
  "type": "permission.asked",
  "properties": {
    "id": "per_c47d90dc80018peRggfCfQj6hi",
    "sessionID": "ses_3b8338d9dffe80imMNvaSYpHl3",
    "permission": "bash",
    "patterns": ["echo hello"],
    "metadata": {},
    "always": ["echo *"],
    "tool": {
      "messageID": "msg_c47d8fa52001nXIEGeUzvhuZ3A",
      "callID": "call_function_j4z7buxm38eo_1"
    }
  }
}
```

å­—æ®µè¯´æ˜:
- `id` â†’ pid (permission ID)ï¼Œç”¨äº `/session/{sid}/permissions/{pid}`
- `sessionID` â†’ sid (session ID)
- `permission` â†’ æƒé™ç±»å‹ (bash, file ç­‰)
- `patterns` â†’ è¦æ‰§è¡Œçš„å‘½ä»¤
- `always` â†’ å¦‚æœé€‰ ALWAYSï¼ŒåŒ¹é…çš„ glob æ¨¡å¼

---

## OpenClaw Webhook API è°ƒæŸ¥

### å·²çŸ¥ç«¯ç‚¹

| ç«¯ç‚¹ | æ¥æº | è¯´æ˜ |
|------|------|------|
| `POST /hooks/agent` | å½“å‰ä»£ç ä½¿ç”¨ | æ¥å— `message`, `name`, `sessionKey`, `wakeMode`, `channel`, `to` |
| `POST /hooks/wake` | å®˜æ–¹æ–‡æ¡£æåˆ° | æ¥å— `text`, `mode` ("now" / "next-heartbeat") |
| `POST /hooks/file-chooser` | æºç  routes.js | å†…éƒ¨ç”¨ |
| `POST /hooks/dialog` | æºç  routes.js | å†…éƒ¨ç”¨ |

### `/hooks/agent` å‚æ•°ï¼ˆå·²éªŒè¯å¯ç”¨ï¼‰

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `message` | string | æ¶ˆæ¯å†…å®¹ |
| `name` | string | å‘é€è€…åç§° |
| `sessionKey` | string | session æ ‡è¯†ï¼ˆç›¸åŒ key å¤ç”¨ sessionï¼‰ |
| `wakeMode` | string | `"now"` ç«‹å³å”¤é†’ |
| `channel` | string | æŠ•é€’é€šé“ `"telegram"` |
| `to` | string | ç›®æ ‡ç¾¤ç»„ ID |

### å¾…éªŒè¯å‚æ•°

| å‚æ•° | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `agentId` | æŒ‡å®šè·¯ç”±åˆ°å“ªä¸ª agent | â“ å·²æ·»åŠ åˆ°ä»£ç ï¼Œå¾…é‡å¯ OpenCode éªŒè¯ |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **é‡å¯ OpenCode** ä½¿æ’ä»¶æ›´æ–°ç”Ÿæ•ˆï¼ˆ`agentId: "kiro"` ä¿®æ”¹ï¼‰
2. **è§¦å‘ä¸€ä¸ª permission.asked** æµ‹è¯•æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ° kiro agent
3. **æ£€æŸ¥ gateway.err.log** ç¡®è®¤ lane æ˜¯å¦å˜ä¸º `session:agent:kiro:hermes-notifications`
4. **å¦‚æœ agentId ä¸ç”Ÿæ•ˆ**ï¼Œå°è¯•æ”¹ `name: "kiro"` æˆ–æŸ¥çœ‹ OpenClaw æºç ä¸­ `/hooks/agent` çš„è·¯ç”±é€»è¾‘
5. **éªŒè¯å®Œæ•´é—­ç¯**: ç”¨æˆ·å›å¤ RUN â†’ agent æ‰§è¡Œ curl â†’ OpenCode ç»§ç»­

---

**æœ€åæ›´æ–°**: 2026-02-10
