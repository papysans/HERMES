# é—®é¢˜: Hermes æ’ä»¶æ— æ³•æ¨é€åˆ° Telegram

> ğŸ“… å‘ç°æ—¥æœŸ: 2026-02-10  
> ğŸ“Œ ä¸¥é‡ç¨‹åº¦: ğŸ”´ ä¸¥é‡  
> ğŸ¯ é—®é¢˜ç±»å‹: é…ç½® / æ¶æ„

---

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**: OpenCode ä»»åŠ¡å®Œæˆï¼ˆsession.idleï¼‰å’Œæƒé™è¯·æ±‚ï¼ˆpermission.askedï¼‰å‡ä¸ä¼šæ¨é€åˆ° Telegram ç¾¤ç»„ã€‚Permission æ¶ˆæ¯å¶å°”è·‘åˆ°ä¸» BOT DM è€ŒéæŒ‡å®šç¾¤ç»„ã€‚

**å½±å“èŒƒå›´**: Hermes åŒå‘é€šä¿¡å®Œå…¨å¤±æ•ˆï¼Œç”¨æˆ·æ— æ³•è¿œç¨‹ç›‘æ§å’Œå®¡æ‰¹ OpenCode æ“ä½œã€‚

---

## ğŸ” æ’æŸ¥è¿‡ç¨‹

### é—®é¢˜ 1: æ‰€æœ‰é€šçŸ¥éƒ½ä¸å‘é€

**æ ¹å› **: `HERMES_HOOK_TOKEN` ç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼ˆä¸ºç©ºï¼‰ã€‚

æ’ä»¶åˆå§‹åŒ–æ—¶æ£€æŸ¥ `if (!HOOK_TOKEN)` ç›´æ¥ return ç©ºå¯¹è±¡ï¼Œæ‰€æœ‰äº‹ä»¶ç›‘å¬éƒ½æœªæ³¨å†Œã€‚

**éªŒè¯**:
```bash
echo "TOKEN=[$HERMES_HOOK_TOKEN]"
# è¾“å‡º: TOKEN=[]
```

**ä¿®å¤**: åœ¨ `~/.zshrc` ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼š
```bash
export HERMES_HOOK_TOKEN="<token>"
export HERMES_OPENCLAW_URL="http://localhost:18789"
export HERMES_TELEGRAM_CHANNEL="-5088310983"
```

Token å€¼æ¥æº: `~/.config/openclaw/openclaw.json` â†’ `hooks.token`

### é—®é¢˜ 2: OpenCode é‡å¯åç¯å¢ƒå˜é‡ä¸¢å¤±

**ç°è±¡**: OpenCode 21:44 é‡å¯åï¼Œhermes-hook.js æ’ä»¶æ—¥å¿—æ˜¾ç¤º `âš ï¸ HERMES_HOOK_TOKEN æœªè®¾ç½®ï¼Œé€šçŸ¥åŠŸèƒ½ç¦ç”¨`ã€‚

**æ ¹å› **: `.zshrc` ä¸­çš„ `export HERMES_HOOK_TOKEN=...` æ˜¯åœ¨ OpenCode è¿è¡ŒæœŸé—´æ·»åŠ çš„ã€‚é‡å¯ OpenCode çš„ terminal çª—å£å¦‚æœåœ¨ export ä¹‹å‰å°±æ‰“å¼€äº†ï¼Œæ²¡æœ‰é‡æ–° `source ~/.zshrc`ï¼Œæ–°å¯åŠ¨çš„ OpenCode è¿›ç¨‹å°±æ‹¿ä¸åˆ°è¿™ä¸ªå˜é‡ã€‚

**æ—¥å¿—è¯æ®**:
```
# ~/.local/share/opencode/log/2026-02-10T134443.log
INFO  2026-02-10T13:44:45 service=plugin path=file:///...hermes-hook.js loading plugin
WARN  2026-02-10T13:44:45 service=hermes âš ï¸ HERMES_HOOK_TOKEN æœªè®¾ç½®ï¼Œé€šçŸ¥åŠŸèƒ½ç¦ç”¨
```

**éªŒè¯**:
```bash
# å½“å‰ shell æ²¡æœ‰å˜é‡
echo "TOKEN=[$HERMES_HOOK_TOKEN]"
# TOKEN=[]

# source åæœ‰
source ~/.zshrc; echo "TOKEN=[$HERMES_HOOK_TOKEN]"
# TOKEN=[c921...]
```

**ä¿®å¤**: é‡å¯ OpenCode å‰ç¡®ä¿ `source ~/.zshrc`ï¼Œæˆ–åœ¨å¯åŠ¨å‘½ä»¤å‰ inline exportï¼š
```bash
source ~/.zshrc
opencode --port 4096
```

**é•¿æœŸæ–¹æ¡ˆ**: è€ƒè™‘ç”¨ OpenCode çš„ `shell.env` æ’ä»¶é’©å­æ³¨å…¥ç¯å¢ƒå˜é‡ï¼Œä¸ä¾èµ– shellã€‚

### é—®é¢˜ 3: OpenClaw agent ç”¨åŒæ­¥ API å¯¼è‡´é˜»å¡

**ç°è±¡**: OpenClaw agent é€šè¿‡ `POST /session/{id}/message` å‘é€æ¶ˆæ¯åï¼Œæ˜¾ç¤º "Command still running"ï¼Œpoll å¤šæ¬¡æ— è¾“å‡ºï¼Œæœ€ç»ˆæ”¾å¼ƒã€‚

**æ ¹å› **: `/message` æ˜¯åŒæ­¥æ¥å£ï¼Œç­‰å¾… AI å®Œæˆæ‰è¿”å›ã€‚å½“æ¶ˆæ¯è§¦å‘ `permission.asked` äº‹ä»¶æ—¶ï¼Œsession è¢«æŒ‚èµ·ç­‰å¾…å®¡æ‰¹ï¼ŒHTTP è¯·æ±‚æ°¸è¿œä¸è¿”å›ï¼Œå¯¼è‡´ OpenClaw agent çš„ exec å·¥å…·è¶…æ—¶ã€‚

**å®˜æ–¹æ–‡æ¡£ç¡®è®¤**ï¼ˆ[dev.opencode.ai/docs/server](https://dev.opencode.ai/docs/server/)ï¼‰:
- `POST /session/:id/message` â€” åŒæ­¥ï¼Œç­‰å¾… AI å“åº”å®Œæˆ
- `POST /session/:id/prompt_async` â€” å¼‚æ­¥ï¼Œç«‹å³è¿”å› 204 No Content

**ä¿®å¤**: å·²å°† SOUL.md å’Œ TOOLS.md ä¸­çš„ `/message` æ”¹ä¸º `/prompt_async`ã€‚agent å‘é€æ¶ˆæ¯åç«‹å³è¿”å›ï¼Œä¸é˜»å¡ã€‚OpenCode çš„å›å¤é€šè¿‡ hermes-hook.js æ’ä»¶è‡ªåŠ¨æ¨é€åˆ° Telegramã€‚

### é—®é¢˜ 4: deliver æ¨¡å¼ä¸å·¥ä½œ

**ç°è±¡**: `deliver: true` è¿”å› `{"ok":true}` ä½† TG æ— æ¶ˆæ¯ã€‚

**åŸå› **: OpenClaw çš„ `deliver` æŠ•é€’çš„æ˜¯ agent å¤„ç†åçš„æœ€ç»ˆå›å¤ï¼Œä¸æ˜¯åŸå§‹ message çš„ç›´æŠ•ã€‚æ²¡æœ‰ prior delivery route æ—¶æŠ•é€’é™é»˜å¤±è´¥ã€‚

**éªŒè¯**:
```bash
# deliver æ¨¡å¼ â€” TG æ— æ¶ˆæ¯
curl ... -d '{"message":"test","deliver":true,"channel":"telegram","to":"-5088310983"}'
# {"ok":true} ä½† TG æ²¡æ”¶åˆ°

# wakeMode æ¨¡å¼ â€” TG æ”¶åˆ°
curl ... -d '{"message":"test","wakeMode":"now"}'
# TG æ”¶åˆ°ï¼ˆä½†åˆ°äº†ä¸» BOT DMï¼‰
```

### é—®é¢˜ 3: æ¶ˆæ¯è·¯ç”±åˆ°ä¸» BOT è€Œéç¾¤ç»„

**ç°è±¡**: ä¸æŒ‡å®š `channel`/`to` æ—¶ï¼Œagent å›å¤èµ°é»˜è®¤ delivery routeï¼ˆä¸» BOT DMï¼‰ã€‚

**éªŒè¯**:
```bash
# å¸¦ channel + to â€” åˆ°ç¾¤ç»„ âœ…
curl ... -d '{"message":"test","wakeMode":"now","channel":"telegram","to":"-5088310983"}'

# ä¸å¸¦ channel/to â€” åˆ°ä¸» BOT DM âŒ
curl ... -d '{"message":"test","wakeMode":"now"}'
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### å·²ä¿®å¤

1. **ç¯å¢ƒå˜é‡**: åœ¨ `~/.zshrc` æŒä¹…åŒ– `HERMES_HOOK_TOKEN`
2. **ç»Ÿä¸€å‘é€æ¨¡å¼**: `sendToOpenClaw()` å‡½æ•°ç®€åŒ–ä¸ºå•ä¸€æ¨¡å¼ï¼Œæ‰€æœ‰æ¶ˆæ¯ç»Ÿä¸€ä½¿ç”¨ï¼š
   ```javascript
   {
     message,
     name: 'Hermes',
     sessionKey: 'hermes-notifications',
     wakeMode: 'now',
     channel: 'telegram',
     to: TELEGRAM_CHANNEL
   }
   ```
   å»æ‰äº† `deliver: true`ï¼Œå»æ‰äº† `direct`/`permission` åˆ†æ”¯é€»è¾‘ã€‚
3. **SOUL.md / TOOLS.md æ”¹ç”¨ prompt_async**: OpenClaw agent å‘é€æ¶ˆæ¯æ”¹ç”¨å¼‚æ­¥æ¥å£ï¼Œé¿å…åŒæ­¥é˜»å¡ã€‚

### å¾…éªŒè¯

- [ ] é‡å¯ OpenCode åæ’ä»¶æ˜¯å¦æ­£å¸¸åˆå§‹åŒ–ï¼ˆç¡®ä¿ `source ~/.zshrc` åå†å¯åŠ¨ï¼‰
- [ ] `prompt_async` å‘é€å OpenCode æ˜¯å¦æ­£å¸¸å¤„ç†æ¶ˆæ¯
- [ ] permission.asked äº‹ä»¶æ˜¯å¦èƒ½é€šè¿‡ hermes-hook.js æ¨é€åˆ° Telegram
- [ ] è¿ç»­å¤šä¸ª permission è¯·æ±‚æ˜¯å¦éƒ½èƒ½ç‹¬ç«‹åˆ°è¾¾ç¾¤ç»„

---

## âš ï¸ é—ç•™é—®é¢˜

1. **ç¯å¢ƒå˜é‡æ³¨å…¥ä¸å¯é **: å½“å‰ä¾èµ– `.zshrc` ä¸­çš„ exportï¼Œå¦‚æœ terminal æ²¡æœ‰ source å°±å¯åŠ¨ OpenCodeï¼Œæ’ä»¶ä¼šé™é»˜ç¦ç”¨ã€‚é•¿æœŸåº”è€ƒè™‘ç”¨ `shell.env` æ’ä»¶é’©å­æˆ–åœ¨æ’ä»¶å†…ä»é…ç½®æ–‡ä»¶è¯»å– tokenã€‚

2. **session.idle æ¶ˆæ¯å†…å®¹è·å–**: ä¾èµ– `localhost:4096/session/{id}/message?limit=1` APIï¼Œå¦‚æœè¿”å›æ•°æ®ç»“æ„ä¸ `m.info?.role === 'assistant'` ä¸åŒ¹é…ï¼Œcontent ä¼šä¸ºç©ºè¢«è·³è¿‡ã€‚éœ€è¦å®é™…è§¦å‘åæ£€æŸ¥ `/tmp/hermes-perm-*.json` è°ƒè¯•æ–‡ä»¶ç¡®è®¤ã€‚

3. **Permission é—­ç¯æœªéªŒè¯**: ç”¨æˆ·åœ¨ TG ç¾¤ç»„å›å¤ RUN/ALWAYS/REJECT åï¼ŒHermes agent æ˜¯å¦èƒ½æ­£ç¡®è¯†åˆ«å¹¶æ‰§è¡Œ curl å›ä¼  OpenCodeï¼Œå–å†³äº agent çš„ SOUL.md æŒ‡ä»¤éµå®ˆç¨‹åº¦ã€‚

4. **agent è‡ªä½œä¸»å¼ é£é™©**: `wakeMode: "now"` ä¼šå”¤é†’ agent sessionï¼Œagent çœ‹åˆ° ğŸ”´ æ¶ˆæ¯åå¯èƒ½è‡ªè¡Œé€‰æ‹© RUN è€Œéç­‰å¾…ç”¨æˆ·ã€‚å½“å‰é  SOUL.md é“å¾‹çº¦æŸï¼Œä½† LLM ä¸æ˜¯ 100% å¯é ã€‚

5. **prompt_async æ— ç›´æ¥å›å¤**: æ”¹ç”¨ `prompt_async` åï¼ŒOpenClaw agent ä¸å†èƒ½ç›´æ¥æ‹¿åˆ° AI å›å¤ã€‚å›å¤éœ€è¦é€šè¿‡ hermes-hook.js çš„ `session.idle` äº‹ä»¶æ¨é€ã€‚å¦‚æœæ’ä»¶æœªåˆå§‹åŒ–ï¼ˆtoken é—®é¢˜ï¼‰ï¼Œå›å¤ä¼šä¸¢å¤±ã€‚

---

**è§£å†³çŠ¶æ€**: âš ï¸ éƒ¨åˆ†è§£å†³ï¼ˆé…ç½®å·²ä¿®å¤ + API æ”¹ä¸ºå¼‚æ­¥ï¼Œå¾…é‡å¯ OpenCode éªŒè¯ï¼‰

**æœ€åæ›´æ–°**: 2026-02-10
